<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GenSafe — Community Safety (Vanilla)</title>
  <meta name="description" content="GenSafe — quick-access safety toolkit with map, SOS, reports and community chat (demo)" />

  <!-- Manifest for PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#1E88E5" />

  <!-- Basic styling (optional: move to styles.css) -->
  <style>
    :root{--blue:#1E88E5;--dark:#121212;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0; background:linear-gradient(180deg,#fff,#f3f6fb); color:#111}
    header{max-width:1100px;margin:16px auto;display:flex;align-items:center;justify-content:space-between;padding:12px}
    .logo{display:flex;gap:12px;align-items:center}
    .logo .badge{width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,var(--blue),#1565C0);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    main{max-width:1100px;margin:8px auto;padding:12px;display:grid;row-gap:16px}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
    .flex{display:flex;gap:12px}
    .btn{background:var(--blue);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;display:inline-block}
    #map{width:100%;height:56vh;border-radius:10px;overflow:hidden}
    form>*{margin-bottom:8px}
    .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 380px}}
    .sos{position:fixed;right:18px;bottom:18px;background:#e53935;color:#fff;border-radius:999px;width:76px;height:76px;display:flex;align-items:center;justify-content:center;font-weight:700;z-index:999;box-shadow:0 8px 24px rgba(229,57,53,.18)}
    .resources-list{display:grid;gap:8px}
    .resource{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#f8fafc}
    .chat-box{height:40vh;overflow:auto;padding:8px;background:#f7f8fb;border-radius:8px}
    footer{max-width:1100px;margin:12px auto;text-align:center;color:var(--muted);font-size:13px;padding-bottom:24px}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <div class="badge">GS</div>
      <div>
        <div style="font-weight:700;font-size:18px">GenSafe</div>
        <div style="font-size:12px;color:var(--muted)">Safety • Community • Support — India</div>
      </div>
    </div>
    <nav class="hidden-sm">
      <a href="#map" style="margin-right:8px">Map</a>
      <a href="#report" style="margin-right:8px">Report</a>
      <a href="#chat" style="margin-right:8px">Chat</a>
      <a href="#resources">Resources</a>
    </nav>
  </header>

  <main>
    <!-- Hero -->
    <section class="card flex" style="align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:240px">
        <h1 style="margin:0;font-size:22px">GenSafe — Safety in your pocket</h1>
        <p style="color:var(--muted);margin:6px 0 0">Quickly access emergency contacts, find nearby help, submit reports, and chat with the community.</p>
        <div style="margin-top:10px" class="flex">
          <a href="#map" class="btn">Open Map</a>
          <a href="#chat" class="btn" style="background:#fff;color:var(--blue);border:1px solid #e6eefc">Open Chat</a>
        </div>
      </div>
      <div style="width:260px;min-width:200px">
        <div class="card" style="padding:10px">
          <div style="font-weight:600">Quick Actions</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <button id="open-sos" class="btn" style="background:#e53935">SOS</button>
            <a href="#report" class="btn" style="background:#43A047">Report an incident</a>
            <a href="#resources" class="btn" style="background:#1565C0">Resources</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Map + Report -->
    <section class="grid-2">
      <div class="card">
        <div id="map">Loading map…</div>
      </div>

      <aside class="card" id="report">
        <h3 style="margin-top:0">Report an incident</h3>
        <form id="report-form">
          <label>Category</label>
          <select id="report-category" required>
            <option value="danger">Harassment / Assault</option>
            <option value="suspicious">Suspicious activity</option>
            <option value="safe">Safe zone / Help available</option>
          </select>

          <label>Short description</label>
          <textarea id="report-desc" rows="3" placeholder="Briefly describe what happened"></textarea>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button type="submit" class="btn" style="background:#43A047">Submit</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Nearest Places</h4>
          <p style="color:var(--muted);margin:0 0 8px 0">Use the map search (top-left on desktop) to find police stations or hospitals.</p>
        </div>
      </aside>
    </section>

    <!-- Chat + Resources -->
    <section class="grid-2">
      <div class="card" id="chat">
        <h3 style="margin-top:0">Community Chat</h3>
        <div class="chat-box" id="chat-box">Loading chat…</div>
        <form id="chat-form" style="display:flex;gap:8px;margin-top:8px">
          <input id="chat-input" placeholder="Write a supportive message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefc" />
          <button class="btn" type="submit">Send</button>
        </form>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Resources (India)</h3>
        <div class="resources-list" id="resources-list"></div>
      </div>
    </section>

  </main>

  <div id="sos-float" class="sos" style="display:none">SOS</div>

  <footer>Made with ❤️ — GenSafe demo • Add API keys & Firebase config to enable full features.</footer>

  <!-- Load Google Maps async with callback -->
  <script>
    function loadMaps(){
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key=REPLACE_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap';
      s.async = true; s.defer = true; document.head.appendChild(s);
    }
    window.addEventListener('load', loadMaps);
  </script>

  <!-- Inline app logic (you can extract to script.js) -->
  <script>
    // ---------- Firebase config: replace with your project's values ----------
    const firebaseConfig = {
      apiKey: "REPLACE_FIREBASE_API_KEY",
      authDomain: "REPLACE_FIREBASE_AUTH_DOMAIN",
      projectId: "REPLACE_FIREBASE_PROJECT_ID",
      storageBucket: "REPLACE_FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "REPLACE_FIREBASE_MESSAGING_SENDER_ID",
      appId: "REPLACE_FIREBASE_APP_ID"
    };

    // Initialize Firebase (compat libs loaded in head)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UI refs & resources
    const resources = [
      {name:'Police (All-purpose)', number:'112'},
      {name:'Ambulance', number:'108'},
      {name:'Women Helpline', number:'181'},
      {name:'KIRAN Mental Health', number:'18005990019'}
    ];

    const resourcesList = document.getElementById('resources-list');
    resources.forEach(r => {
      const el = document.createElement('div'); el.className='resource';
      el.innerHTML = `<div><strong>${r.name}</strong><div style='font-size:12px;color:#666'>${r.number}</div></div><div style='display:flex;gap:6px'><a class='btn' href='tel:${r.number}'>Call</a><button class='btn' style='background:#fff;color:var(--blue);border:1px solid #e6eefc' onclick="navigator.clipboard.writeText('${r.number}')">Copy</button></div>`;
      resourcesList.appendChild(el);
    });

    // Chat
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    function appendMessage(msg){
      const d = document.createElement('div'); d.style.marginBottom='8px';
      d.innerHTML = `<div style='font-size:13px;color:#334155'><strong>${msg.username||'Guest'}</strong> <span style='font-size:11px;color:#94a3b8'>${msg.createdAt?new Date(msg.createdAt).toLocaleString():''}</span></div><div style='background:#f1f5f9;padding:8px;border-radius:8px;margin-top:4px'>${msg.text}</div>`;
      chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Real-time chat listener
    db.collection('chat').orderBy('createdAt','asc').onSnapshot(snap=>{
      chatBox.innerHTML='';
      snap.forEach(doc=>{
        const data = doc.data();
        appendMessage({username:data.username,text:data.text,createdAt:data.createdAt?data.createdAt.toDate():null});
      })
    });

    // Chat send
    chatForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = chatInput.value.trim(); if(!text) return;
      const username = localStorage.getItem('gensafe_username') || prompt('Enter a display name for chat (first name is fine)') || 'Guest';
      localStorage.setItem('gensafe_username',username);
      await db.collection('chat').add({username,text,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      chatInput.value='';
    });

    // Report submit
    const reportForm = document.getElementById('report-form');
    reportForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const category = document.getElementById('report-category').value;
      const description = document.getElementById('report-desc').value;

      // get location
      let coords = {lat:28.6139,lng:77.209}; // fallback (New Delhi)
      try{
        const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(p=>res(p),rej,{timeout:8000}));
        coords = {lat:pos.coords.latitude,lng:pos.coords.longitude};
      }catch(e){console.warn('geolocation failed',e)}

      await db.collection('reports').add({category,description,location:coords,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      alert('Report submitted — will appear on the map shortly.');
      reportForm.reset();
    });

    // Map logic (initMap callback used by Google Maps script)
    let map, markers=[];
    window.initMap = function(){
      map = new google.maps.Map(document.getElementById('map'),{center:{lat:28.6139,lng:77.209},zoom:13});

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          map.setCenter({lat:p.coords.latitude,lng:p.coords.longitude});
          new google.maps.Marker({position:{lat:p.coords.latitude,lng:p.coords.longitude},map,title:'You are here'});
        },()=>{});
      }

      // Places search box
      const input = document.createElement('input'); input.placeholder='Search places'; input.style.cssText='margin:10px;padding:8px;width:260px;border-radius:8px;border:1px solid #e6eefc';
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
      const searchBox = new google.maps.places.SearchBox(input);
      searchBox.addListener('places_changed', ()=>{
        const places = searchBox.getPlaces(); if(!places||places.length===0) return; const p=places[0]; if(p.geometry) map.panTo(p.geometry.location);
      });

      // Subscribe to reports and draw markers
      db.collection('reports').orderBy('createdAt','desc').onSnapshot(snap=>{
        // clear old markers
        markers.forEach(m=>m.setMap(null)); markers=[];
        snap.forEach(doc=>{
          const d = doc.data(); if(!d.location) return;
          const pos = {lat:d.location.lat,lng:d.location.lng};
          const color = d.category==='safe'? '#43A047' : d.category==='suspicious' ? '#F9A825' : '#E53935';
          const marker = new google.maps.Marker({position:pos,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:color,fillOpacity:1,strokeWeight:0}});
          const inf = new google.maps.InfoWindow({content:`<strong>${d.category}</strong><p>${(d.description||'').slice(0,200)}</p><small>${d.createdAt?new Date(d.createdAt.toDate()).toLocaleString():''}</small>`});
          marker.addListener('click',()=>inf.open(map,marker));
          markers.push(marker);
        })
      });
    }

    // SOS UI open (opens a new small tab with click-to-call actions)
    document.getElementById('open-sos').addEventListener('click', ()=>{
      const win = window.open('', '_blank');
      const html = `<!doctype html><html><head><meta name='viewport' content='width=device-width,initial-scale=1'></head><body style='font-family:Inter,system-ui;padding:20px'><h2>SOS Quick Actions</h2><div style='display:flex;flex-direction:column;gap:8px;margin-top:12px'><a href='tel:112' style='display:block;padding:12px;background:#1E88E5;color:#fff;border-radius:8px;text-decoration:none'>Call 112 (Police)</a><a href='tel:108' style='display:block;padding:12px;background:#1565C0;color:#fff;border-radius:8px;text-decoration:none;margin-top:8px'>Call 108 (Ambulance)</a><a href='tel:181' style='display:block;padding:12px;background:#e53935;color:#fff;border-radius:8px;text-decoration:none;margin-top:8px'>Call 181 (Women Helpline)</a></div></body></html>`;
      win.document.write(html); win.document.close();
    });

    // Register service worker if available
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registered')).catch(()=>{});
      });
    }
  </script>

</body>
</html>
