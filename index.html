<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GenSafe ‚Äî Safety & Support</title>
  <meta name="description" content="GenSafe ‚Äî Safety toolkit: SOS, Map, Reports, Chat & Resources (Hackathon-ready)" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/heroicons@1.0.6/dist/heroicons.min.css"/>

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* Extra small polish beyond Tailwind */
    html,body,#app { height:100%; }
    .glass { background: rgba(255,255,255,0.72); backdrop-filter: blur(6px); }
    .map-card { height:60vh; min-height:380px; border-radius: 14px; overflow:hidden; }
    .glow-red { box-shadow: 0 8px 30px rgba(239,68,68,0.18); }
    .glow-blue { box-shadow: 0 8px 30px rgba(14,165,233,0.12); }
    /* small responsive tweak for chat height */
    @media(min-width:1024px){ .chat-height { height:40vh; } }
    @media(max-width:1023px){ .chat-height { height:30vh; } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

<div id="app" class="min-h-screen flex flex-col">

  <!-- NAV -->
  <header class="w-full bg-white/80 glass shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-lg bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center text-white font-bold">GS</div>
        <div>
          <div class="font-semibold text-lg">GenSafe</div>
          <div class="text-xs text-slate-500">Safety ‚Ä¢ Community ‚Ä¢ Support ‚Äî India</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-6">
        <a href="#map" class="text-slate-700 hover:text-sky-600">Map</a>
        <a href="#report" class="text-slate-700 hover:text-sky-600">Report</a>
        <a href="#chat" class="text-slate-700 hover:text-sky-600">Chat</a>
        <a href="#resources" class="text-slate-700 hover:text-sky-600">Resources</a>
        <button id="installBtn" class="ml-4 px-3 py-1.5 rounded-md text-sm border border-slate-200 text-slate-700">Install</button>
      </nav>

      <!-- mobile nav button -->
      <div class="md:hidden">
        <button id="openMobileMenu" class="p-2 rounded-md bg-slate-100">
          ‚ò∞
        </button>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="container mx-auto px-4 pt-8 pb-6">
    <div class="grid lg:grid-cols-3 gap-6 items-start">
      <div class="lg:col-span-2">
        <div class="p-6 rounded-2xl glass glow-blue">
          <div class="flex items-start justify-between gap-6">
            <div>
              <h1 class="text-3xl font-bold text-slate-800">Your Safety, Our Priority</h1>
              <p class="mt-2 text-slate-600">Quickly access emergency contacts, find nearby help, submit verified reports, and get community support ‚Äî built for hackathons and real-world demos.</p>
              <div class="mt-4 flex gap-3">
                <button id="sosBtn" class="px-5 py-3 rounded-full bg-red-600 text-white font-semibold hover:bg-red-700 glow-red">üö® SOS</button>
                <a href="#map" class="px-5 py-3 rounded-full bg-white border border-slate-200 text-slate-800 font-semibold hover:shadow">üìç Open Map</a>
                <a href="#chat" class="px-5 py-3 rounded-full bg-white border border-slate-200 text-slate-800 font-semibold hover:shadow">üí¨ Open Chat</a>
              </div>
            </div>

            <div class="hidden md:block w-48">
              <div class="bg-white p-4 rounded-xl shadow">
                <div class="text-sm font-medium text-slate-600">Quick Actions</div>
                <div class="mt-3 flex flex-col gap-2">
                  <button id="quickReport" class="px-3 py-2 rounded-md bg-green-600 text-white">Report Incident</button>
                  <a href="#resources" class="px-3 py-2 rounded-md bg-sky-600 text-white">View Resources</a>
                  <button id="shareBtn" class="px-3 py-2 rounded-md bg-white text-slate-700 border">Share</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- MAP CARD -->
        <div id="mapCard" class="mt-6 card map-card bg-white shadow-lg p-0">
          <div id="map" class="w-full h-full"></div>
        </div>

      </div>

      <!-- RIGHT COLUMN: Report + Chat + Resources compact -->
      <aside class="space-y-6">
        <!-- Report form -->
        <div id="report" class="p-4 bg-white rounded-2xl shadow">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">Report an incident</h3>
            <div class="text-xs text-slate-500">Be brief & safe</div>
          </div>
          <form id="report-form" class="mt-3 space-y-3">
            <select id="report-category" class="w-full rounded-md border px-3 py-2">
              <option value="danger">Harassment / Assault</option>
              <option value="suspicious">Suspicious activity</option>
              <option value="safe">Safe place / Help available</option>
            </select>
            <textarea id="report-desc" placeholder="Short description (optional, avoid personal data)" class="w-full rounded-md border px-3 py-2 h-24"></textarea>
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-500">Location: <span id="report-loc" class="font-medium">Detecting‚Ä¶</span></div>
              <div class="flex gap-2">
                <button type="button" id="useMapPin" class="px-3 py-2 rounded-md bg-slate-100">Use Map Pin</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-green-600 text-white font-semibold">Submit</button>
              </div>
            </div>
            <div id="report-msg" class="text-sm text-green-600 hidden">Report submitted.</div>
          </form>
        </div>

        <!-- Chat -->
        <div id="chat" class="p-4 bg-white rounded-2xl shadow">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Community Chat</h3>
            <div class="text-xs text-slate-500">Respectful support only</div>
          </div>
          <div id="chat-box" class="chat-height mt-3 overflow-y-auto rounded-md p-2 bg-slate-50 border" ></div>
          <form id="chat-form" class="mt-3 flex gap-2">
            <input id="chat-input" class="flex-1 rounded-md border px-3 py-2" placeholder="Write a supportive message..." />
            <button class="px-4 py-2 rounded-md bg-sky-600 text-white">Send</button>
          </form>
        </div>

        <!-- Resources -->
        <div id="resources" class="p-4 bg-white rounded-2xl shadow">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Emergency Resources (India)</h3>
            <button id="copyAll" class="text-xs text-slate-500">Copy all</button>
          </div>
          <div id="resources-list" class="mt-3 space-y-2"></div>
        </div>
      </aside>

    </div>
  </section>

  <!-- Bottom nav for mobile -->
  <nav class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 md:hidden">
    <div class="bg-white px-4 py-2 rounded-full shadow-xl flex items-center gap-4">
      <a href="#map" class="text-slate-700">üìç</a>
      <a href="#chat" class="text-slate-700">üí¨</a>
      <button id="sosBtnMobile" class="px-4 py-2 rounded-full bg-red-600 text-white font-semibold">SOS</button>
      <a href="#resources" class="text-slate-700">üìû</a>
    </div>
  </nav>

  <footer class="mt-auto py-6 text-center text-sm text-slate-500">Made with ‚ù§Ô∏è ‚Äî GenSafe Demo ‚Ä¢ Replace API keys & Firebase config to enable full features</footer>
</div>

<!-- Load Google Maps async -->
<script>
  function loadMaps(){
    const s = document.createElement('script');
    s.src = 'https://maps.googleapis.com/maps/api/js?key=REPLACE_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap';
    s.async = true; s.defer = true; document.head.appendChild(s);
  }
  window.addEventListener('load', loadMaps);
</script>

<!-- APP LOGIC (inline for hackathon speed) -->
<script>
/* ========== FIREBASE CONFIG ‚Äî REPLACE placeholders ========== */
const firebaseConfig = {
  apiKey: "REPLACE_FIREBASE_API_KEY",
  authDomain: "REPLACE_FIREBASE_AUTH_DOMAIN",
  projectId: "REPLACE_FIREBASE_PROJECT_ID",
  storageBucket: "REPLACE_FIREBASE_STORAGE_BUCKET",
  messagingSenderId: "REPLACE_FIREBASE_MESSAGING_SENDER_ID",
  appId: "REPLACE_FIREBASE_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ========== Anonymous auth so users can write immediately ========== */
async function ensureAuth(){
  if(!auth.currentUser){
    try {
      await auth.signInAnonymously();
      console.log('Signed in anonymously');
    } catch(e) {
      console.error('Auth error', e);
    }
  }
}
auth.onAuthStateChanged(u => {
  if(u) console.log('User', u.uid, 'anon:', u.isAnonymous);
});

/* ========== Basic resources list ========== */
const resources = [
  {name:'Police (All-purpose)', number:'112', note:'All emergencies'},
  {name:'Ambulance', number:'108', note:'Medical emergencies'},
  {name:'Women Helpline', number:'181', note:'Support for women'},
  {name:'KIRAN Mental Health', number:'18005990019', note:'Mental health helpline'},
  {name:'Child Helpline', number:'1098', note:'Child protection'}
];
const resourcesList = document.getElementById('resources-list');
function renderResources(){
  resourcesList.innerHTML = '';
  resources.forEach(r => {
    const el = document.createElement('div');
    el.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-md';
    el.innerHTML = `<div><div class="font-medium">${r.name}</div><div class="text-xs text-slate-500">${r.note}</div></div>
      <div class="flex items-center gap-2">
        <a class="px-3 py-2 rounded-md bg-sky-600 text-white text-sm" href="tel:${r.number}">Call</a>
        <button class="px-3 py-2 rounded-md border text-sm copy-btn" data-num="${r.number}">Copy</button>
      </div>`;
    resourcesList.appendChild(el);
  });
}
renderResources();
document.getElementById('copyAll').addEventListener('click', ()=>{
  const text = resources.map(r=>`${r.name}: ${r.number}`).join('\n');
  navigator.clipboard.writeText(text).then(()=>alert('All numbers copied'));
});
document.addEventListener('click', (e)=>{
  if(e.target && e.target.classList.contains('copy-btn')){
    const n = e.target.dataset.num;
    navigator.clipboard.writeText(n).then(()=>{ alert('Copied '+n) });
  }
});

/* ========== Geolocation & Map ========== */
let map, userMarker, markers = [];
let lastSelectedPos = null;

window.initMap = function(){
  const start = {lat:28.6139, lng:77.2090}; // fallback (New Delhi)
  map = new google.maps.Map(document.getElementById('map'), { center: start, zoom: 13, disableDefaultUI: true });
  // Add zoom controls
  map.setOptions({ zoomControl: true, mapTypeControl:false, streetViewControl:false, fullscreenControl:false });

  // Places search control
  const input = document.createElement('input');
  input.type = 'search';
  input.placeholder = 'Search places (police, hospital...)';
  input.className = 'p-2 rounded-md border';
  const controlDiv = document.createElement('div');
  controlDiv.style.margin = '10px';
  controlDiv.appendChild(input);
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlDiv);
  const searchBox = new google.maps.places.SearchBox(input);
  searchBox.addListener('places_changed', ()=>{
    const places = searchBox.getPlaces();
    if(!places || places.length === 0) return;
    const p = places[0];
    if(p.geometry) map.panTo(p.geometry.location);
  });

  // Click to set local pin for report
  map.addListener('click', (e)=>{
    placePin(e.latLng);
  });

  // Try browser geolocation
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setCenter(p);
      placeUserMarker(p);
      document.getElementById('report-loc').innerText = `${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
      lastSelectedPos = p;
    }, err => {
      console.warn('Geolocation failed', err);
      document.getElementById('report-loc').innerText = 'Fallback (New Delhi)';
    }, {timeout:8000});
  }

  // Listen to Firestore 'reports' and render markers
  db.collection('reports').orderBy('createdAt','desc').limit(200).onSnapshot(snap=>{
    // clear old markers
    markers.forEach(m=>m.setMap(null));
    markers = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(!d.location) return;
      const pos = {lat: d.location.lat, lng: d.location.lng};
      const color = d.category === 'safe' ? '#10b981' : d.category === 'suspicious' ? '#f59e0b' : '#ef4444';
      const marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: color, fillOpacity: 1, strokeWeight: 0 }
      });
      const createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '';
      const info = new google.maps.InfoWindow({ content: `<div style="max-width:240px"><strong>${d.category}</strong><p style="margin:6px 0">${(d.description||'').slice(0,200)}</p><div style="font-size:12px;color:#6b7280">${createdAt}</div></div>` });
      marker.addListener('click', ()=> info.open(map, marker));
      markers.push(marker);
    });
  });
};

function placeUserMarker(p){
  if(userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({ position: p, map: map, title: 'You are here', icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#2563eb', fillOpacity: 1, strokeWeight: 0 }});
}
function placePin(latLng){
  const p = { lat: latLng.lat(), lng: latLng.lng() };
  lastSelectedPos = p;
  document.getElementById('report-loc').innerText = `${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
  // show a temporary marker
  const tmp = new google.maps.Marker({ position: p, map: map, title: 'Report location', icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 6, fillColor: '#7c3aed', fillOpacity: 1, strokeWeight:0 }});
  setTimeout(()=> tmp.setMap(null), 4000);
}

/* ========== Reports: submit to Firestore (we automatically sign in anonymously) ========== */
ensureAuth(); // ensure anon auth

const reportForm = document.getElementById('report-form');
reportForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  await ensureAuth();
  const category = document.getElementById('report-category').value;
  const description = document.getElementById('report-desc').value.trim();
  let coords = lastSelectedPos;
  if(!coords){
    // fallback: try geolocation then server fallback
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout:8000}));
      coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    } catch(e){
      coords = { lat: 28.6139, lng: 77.2090 }; // default
    }
  }
  try {
    await db.collection('reports').add({
      category,
      description,
      location: coords,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      uid: auth.currentUser ? auth.currentUser.uid : null
    });
    document.getElementById('report-msg').classList.remove('hidden');
    setTimeout(()=> document.getElementById('report-msg').classList.add('hidden'), 3000);
    reportForm.reset();
  } catch(err){
    console.error('Report error', err);
    alert('Failed to submit report. Check console.');
  }
});

/* ========== Chat: realtime messages ========== */
const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

function appendChat(doc){
  const d = doc.data();
  const div = document.createElement('div');
  div.className = 'mb-2';
  const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleTimeString() : '';
  div.innerHTML = `<div class="text-xs text-slate-500">${ts}</div><div class="mt-1 p-2 bg-white rounded-md border">${escapeHtml(d.text)}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}
function escapeHtml(text){ return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

db.collection('chat').orderBy('createdAt','asc').limitToLast(200).onSnapshot(snap=>{
  chatBox.innerHTML = '';
  snap.forEach(doc => appendChat(doc));
});

chatForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = chatInput.value.trim();
  if(!text) return;
  await ensureAuth();
  try {
    await db.collection('chat').add({
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      uid: auth.currentUser ? auth.currentUser.uid : null
    });
    chatInput.value = '';
  } catch(e) {
    console.error('Chat send error', e);
    alert('Failed to send message');
  }
});

/* ========== SOS button: quick actions (click-to-call) with confirmation ========== */
function openSosWindow(){
  const html = `<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="font-family:Inter,system-ui;padding:18px"><h2 style="font-family:Inter,system-ui">SOS Quick Actions</h2>
  <p>Tap a number to call. Stay safe.</p>
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
    <a href="tel:112" style="padding:12px;background:#2563eb;color:#fff;border-radius:8px;text-decoration:none;display:block">Call 112 (Police)</a>
    <a href="tel:108" style="padding:12px;background:#0ea5e9;color:#fff;border-radius:8px;text-decoration:none;display:block">Call 108 (Ambulance)</a>
    <a href="tel:181" style="padding:12px;background:#ef4444;color:#fff;border-radius:8px;text-decoration:none;display:block">Call 181 (Women Helpline)</a>
  </div></body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}
document.getElementById('sosBtn').addEventListener('click', openSosWindow);
document.getElementById('sosBtnMobile').addEventListener('click', openSosWindow);

/* Quick UI: Use map pin as report location */
document.getElementById('useMapPin').addEventListener('click', ()=>{
  if(lastSelectedPos) {
    alert('Using selected map location for report.');
  } else {
    alert('Tap on the map to set a location for your report.');
  }
});

/* Share / Install behavior */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').classList.remove('hidden'); });
document.getElementById('installBtn').addEventListener('click', async ()=>{
  if(deferredPrompt){ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; }
});
document.getElementById('shareBtn').addEventListener('click', ()=>{
  const url = location.href;
  if(navigator.share) navigator.share({title:'GenSafe', text:'GenSafe ‚Äî safety toolkit', url}).catch(()=>navigator.clipboard.writeText(url).then(()=>alert('Link copied')));
  else navigator.clipboard.writeText(url).then(()=>alert('Link copied'));
});

/* Register service worker */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registered')).catch(()=>{}));
}
</script>
</body>
</html>
